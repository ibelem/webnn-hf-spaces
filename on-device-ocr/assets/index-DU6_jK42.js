import*as D from"https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/esm/ort.webgpu.min.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function s(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(e){if(e.ep)return;e.ep=!0;const o=s(e);fetch(e.href,o)}})();let L=null;const ie=async()=>{if(L)return L;const n="huggingface.co",t="hf-mirror.com",s="/webml/models-moved/resolve/main/01.onnx",i=async c=>{const r=new AbortController,l=setTimeout(()=>r.abort(),3e3);try{const u=await fetch(`https://${c}${s}`,{method:"HEAD",signal:r.signal,cache:"no-store"});return clearTimeout(l),u.ok}catch(u){return console.log(`Error reaching ${c}:`,u),clearTimeout(l),!1}};return await i(n)?(L=n,n):await i(t)?(console.log(`Hugging Face main domain unreachable. Switching to mirror: ${t}`),L=t,t):(L=n,n)};D.env.wasm.wasmPaths="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/";async function re(n){return new Promise((t,s)=>{const i=new Image;i.crossOrigin="Anonymous",i.onload=()=>t(i),i.onerror=s,n instanceof Blob?i.src=URL.createObjectURL(n):i.src=n})}function ae(n,t=960){const s=document.createElement("canvas");let i=n.width,e=n.height;if(t&&Math.max(i,e)>t){const a=i>e?t/i:t/e;i=i*a,e=e*a}const o=Math.max(Math.ceil(i/32)*32,32),c=Math.max(Math.ceil(e/32)*32,32);s.width=o,s.height=c;const r=s.getContext("2d");r.drawImage(n,0,0,o,c);const l=r.getImageData(0,0,o,c),{data:u}=l,f=[.485,.456,.406],v=[.229,.224,.225],R=[],d=[],p=[];for(let a=0;a<u.length;a+=4)R.push((u[a]/255-f[0])/v[0]),d.push((u[a+1]/255-f[1])/v[1]),p.push((u[a+2]/255-f[2])/v[2]);return Float32Array.from([...R,...d,...p]),{tensor:new D.Tensor("float32",Float32Array.from([...p,...d,...R]),[1,3,c,o]),width:o,height:c,originalWidth:n.width,originalHeight:n.height,imageData:l}}function le(n,t,s,i=.3){const e=n.data,o=new Uint8ClampedArray(t*s*4);for(let c=0;c<e.length;c++){const r=e[c]>i?255:0;o[c*4]=r,o[c*4+1]=r,o[c*4+2]=r,o[c*4+3]=255}return new ImageData(o,t,s)}function de(n,t){if(typeof cv>"u")return console.error("OpenCV not loaded"),[];const s=n.width,i=n.height,e=cv.matFromImageData(n);cv.cvtColor(e,e,cv.COLOR_RGBA2GRAY,0);const o=new cv.MatVector,c=new cv.Mat;cv.findContours(e,o,c,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE);const r=[],l=3,u=document.createElement("canvas");u.width=t.width,u.height=t.height;const f=u.getContext("2d");f.drawImage(t,0,0);const v=f.getImageData(0,0,t.width,t.height),R=cv.matFromImageData(v),d=t.width/s,p=t.height/i;for(let x=0;x<o.size();x++){const a=o.get(x),h=cv.minAreaRect(a);if(cv.RotatedRect.points(h),Math.min(h.size.width,h.size.height)<l)continue;const P=1.5,g=h.size.width,_=h.size.height,F=g*_,k=2*(g+_),B=F*P/k,X=new cv.Size(h.size.width+2*B,h.size.height+2*B),z=new cv.RotatedRect(h.center,X,h.angle),m=cv.RotatedRect.points(z).map($=>({x:$.x*d,y:$.y*p})),T=Math.max(Math.hypot(m[0].x-m[1].x,m[0].y-m[1].y),Math.hypot(m[2].x-m[3].x,m[2].y-m[3].y)),W=Math.max(Math.hypot(m[1].x-m[2].x,m[1].y-m[2].y),Math.hypot(m[3].x-m[0].x,m[3].y-m[0].y)),y=me(m),q=cv.matFromArray(4,1,cv.CV_32FC2,[y[0].x,y[0].y,y[1].x,y[1].y,y[2].x,y[2].y,y[3].x,y[3].y]),K=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,T,0,T,W,0,W]),Y=cv.getPerspectiveTransform(q,K),O=new cv.Mat;if(cv.warpPerspective(R,O,Y,new cv.Size(T,W),cv.INTER_CUBIC,cv.BORDER_REPLICATE,new cv.Scalar),O.rows/O.cols>=1.5){const $=new cv.Mat;cv.rotate(O,$,cv.ROTATE_90_CLOCKWISE),O.delete(),r.push({mat:$,box:y})}else r.push({mat:O,box:y});q.delete(),K.delete(),Y.delete()}return e.delete(),o.delete(),c.delete(),R.delete(),r.sort((x,a)=>x.box[0].y-a.box[0].y),r}function me(n){n.sort((r,l)=>r.x-l.x);const t=n.slice(0,2),s=n.slice(2,4);t.sort((r,l)=>r.y-l.y);const i=t[0],e=t[1];s.sort((r,l)=>r.y-l.y);const o=s[0],c=s[1];return[i,o,c,e]}function ue(n){const s=Math.ceil(n.cols*(48/n.rows)),i=new cv.Size(s,48),e=new cv.Mat;cv.resize(n,e,i,0,0,cv.INTER_LINEAR);const o=e.data,c=[],r=[],l=[];for(let f=0;f<o.length;f+=4)c.push((o[f]/255-.5)/.5),r.push((o[f+1]/255-.5)/.5),l.push((o[f+2]/255-.5)/.5);e.delete();const u=Float32Array.from([...l,...r,...c]);return new D.Tensor("float32",u,[1,3,48,s])}function he(n,t){const s=n.dims;s[2],s[0];const i=s[1],e=s[2],o=n.data;let c="",r=0;const l=[],u=[];for(let d=0;d<i;d++){let p=-1/0,x=-1;const a=d*e;for(let h=0;h<e;h++){const b=o[a+h];b>p&&(p=b,x=h)}l.push(x),u.push(p)}const f=[],v=[];for(let d=0;d<l.length;d++){const p=l[d];p!==0&&(d>0&&p===l[d-1]||(f.push(p),v.push(u[d])))}return c=f.map(d=>t[d-1]||"").join(""),v.length>0&&(r=v.reduce((d,p)=>d+p,0)/v.length),{text:c,meanProb:r}}D.env.wasm.wasmPaths="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/";const J=await ie(),ce=new URLSearchParams(window.location.search),se=ce.get("model")||"0";let E,M;se==="1"?(E=`https://${J}/webnn/PP-OCRv5-ONNX/resolve/main`,M={det:`${E}/ch_PP-OCRv5_det.onnx`,rec:`${E}/ch_PP-OCRv5_rec.onnx`,dic:`${E}/ch_PP-OCRv5_dict.txt`}):(E=`https://${J}/webnn/PP-OCRv4-ONNX/resolve/main`,M={det:`${E}/ch_PP-OCRv4_det.onnx`,rec:`${E}/ch_PP-OCRv4_rec.onnx`,dic:`${E}/ch_PP-OCR_keys_v1.txt`});let A=null,N=null,G=[],Q=null,H=null,Z=null,U=null,V=null,w=ce.get("device")||"wasm",I="";w==="wasm"?I="Wasm":w==="webgpu"?I="WebGPU":w.startsWith("webnn")?I=`WebNN (${(w.includes("-")?w.split("-")[1]:"GPU").toUpperCase()})`:I=w;const C=document.getElementById("status"),fe=document.getElementById("backend-display"),pe=document.getElementById("upload"),ee=document.getElementById("result-container"),j=document.getElementById("canvas-overlay"),te=document.getElementById("image-preview"),ge=document.getElementById("detCom"),we=document.getElementById("detInf"),xe=document.getElementById("recCom"),ve=document.getElementById("recInf"),ye=document.getElementById("backend");async function Ce(){for(C.textContent="Loading OpenCV...";typeof cv>"u";)await new Promise(e=>setTimeout(e,100));C.textContent="OpenCV Loaded. Loading Dictionary...",G=(await(await fetch(M.dic)).text()).split(`
`),G.push(" "),fe.textContent=I,ye.textContent=` Â· ${I}`,C.textContent="Ready. Upload image.",pe.addEventListener("change",async e=>{if(e.target.files.length>0){const o=e.target.files[0];await oe(o)}});const s=document.getElementById("example-link");s&&s.addEventListener("click",async e=>{e.preventDefault(),await oe("img/invoice.jpg")});const i=document.getElementsByName("model-version");for(const e of i)e.value===se&&(e.checked=!0),e.addEventListener("change",o=>{const c=o.target.value,r=new URL(window.location);r.searchParams.set("model",c),window.location.href=r.toString()})}async function ne(n){if(n==="det"&&A)return A;if(n==="rec"&&N)return N;C.textContent=`Loading ${n} model (${w})...`;const t={executionProviders:[w]};if(w.startsWith("webnn")){const r=w.includes("-")?w.split("-")[1]:"gpu";t.executionProviders=[{name:"webnn",deviceType:r,powerPreference:"default"}]}else w==="webgpu"?t.executionProviders=[{name:w,deviceType:"gpu",powerPreference:"default"}]:t.executionProviders=[{name:w,deviceType:"cpu",powerPreference:"default"}];const s=n==="det"?M.det:M.rec;let i=performance.now();const e=await D.InferenceSession.create(s,t),c=performance.now()-i;return n==="det"?(Q=c,ge.textContent=`${Q.toFixed(2)}`,console.log(`Detection model compilation time: ${c.toFixed(2)}ms`)):(Z=c,xe.textContent=`${Z.toFixed(2)}`,console.log(`Recognition model compilation time: ${c.toFixed(2)}ms`)),n==="det"&&A===null?A=e:n==="rec"&&N===null&&(N=e),e}async function oe(n){try{C.textContent="Processing image...",ee.innerHTML="";const t=await re(n);te.src=t.src,te.style.display="block";const s=await ne("det");C.textContent="Running Detection...";const{tensor:i,width:e,height:o,originalWidth:c,originalHeight:r,imageData:l}=ae(t),u={};u[s.inputNames[0]]=i;const f=performance.now(),v=await s.run(u);H=performance.now()-f,we.textContent=`${H.toFixed(2)}`,console.log(`Detection inference time: ${H.toFixed(2)}ms`);const d=v[s.outputNames[0]],p=le(d,e,o);C.textContent="Splitting lines...";const x=de(p,t);j.width=c,j.height=r;const a=j.getContext("2d");a.clearRect(0,0,c,r),a.strokeStyle="red",a.lineWidth=2,x.forEach(P=>{const g=P.box;a.beginPath(),a.moveTo(g[0].x,g[0].y),a.lineTo(g[1].x,g[1].y),a.lineTo(g[2].x,g[2].y),a.lineTo(g[3].x,g[3].y),a.closePath(),a.stroke()}),C.textContent="Running Recognition...";const h=await ne("rec");let b="";for(let P=0;P<x.length;P++){const g=x[P],_=ue(g.mat),F={};F[h.inputNames[0]]=_;const k=performance.now(),B=await h.run(F);U=performance.now()-k,console.log(`Recognition inference time (line ${P+1}): ${U.toFixed(2)}ms`),V=(V||0)+U;const z=B[h.outputNames[0]],{text:S,meanProb:m}=he(z,G);if(m>.3){b+=S+`
`;const T=document.createElement("p");T.textContent=`[${m.toFixed(2)}] ${S}`,ee.appendChild(T)}else console.log(`Low confidence line skipped: "${S}" (${m.toFixed(2)})`);g.mat.delete()}ve.textContent=`${V.toFixed(2)}`,C.textContent=`${I} OCR complete.`,console.log(`OCR Result:
`,b)}catch(t){console.error(t),C.textContent=`Error: ${t.message}`}}Ce();
