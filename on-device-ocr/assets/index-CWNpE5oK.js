import*as ce from"https://cdn.jsdelivr.net/npm/onnxruntime-web@1.23.2/dist/ort.all.min.js";import*as G from"https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/esm/ort.webgpu.min.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&c(s)}).observe(document,{childList:!0,subtree:!0});function i(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function c(e){if(e.ep)return;e.ep=!0;const o=i(e);fetch(e.href,o)}})();let M=null;const ie=async()=>{if(M)return M;const n="huggingface.co",t="hf-mirror.com",i="/webml/models-moved/resolve/main/01.onnx",c=async s=>{const r=new AbortController,l=setTimeout(()=>r.abort(),3e3);try{const u=await fetch(`https://${s}${i}`,{method:"HEAD",signal:r.signal,cache:"no-store"});return clearTimeout(l),u.ok}catch(u){return console.log(`Error reaching ${s}:`,u),clearTimeout(l),!1}};return await c(n)?(M=n,n):await c(t)?(console.log(`Hugging Face main domain unreachable. Switching to mirror: ${t}`),M=t,t):(M=n,n)};G.env.wasm.wasmPaths="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/";async function re(n){return new Promise((t,i)=>{const c=new Image;c.crossOrigin="Anonymous",c.onload=()=>t(c),c.onerror=i,n instanceof Blob?c.src=URL.createObjectURL(n):c.src=n})}function ae(n,t=960){const i=document.createElement("canvas");let c=n.width,e=n.height;if(t&&Math.max(c,e)>t){const a=c>e?t/c:t/e;c=c*a,e=e*a}const o=Math.max(Math.ceil(c/32)*32,32),s=Math.max(Math.ceil(e/32)*32,32);i.width=o,i.height=s;const r=i.getContext("2d");r.drawImage(n,0,0,o,s);const l=r.getImageData(0,0,o,s),{data:u}=l,p=[.485,.456,.406],v=[.229,.224,.225],R=[],d=[],f=[];for(let a=0;a<u.length;a+=4)R.push((u[a]/255-p[0])/v[0]),d.push((u[a+1]/255-p[1])/v[1]),f.push((u[a+2]/255-p[2])/v[2]);return Float32Array.from([...R,...d,...f]),{tensor:new G.Tensor("float32",Float32Array.from([...f,...d,...R]),[1,3,s,o]),width:o,height:s,originalWidth:n.width,originalHeight:n.height,imageData:l}}function le(n,t,i,c=.3){const e=n.data,o=new Uint8ClampedArray(t*i*4);for(let s=0;s<e.length;s++){const r=e[s]>c?255:0;o[s*4]=r,o[s*4+1]=r,o[s*4+2]=r,o[s*4+3]=255}return new ImageData(o,t,i)}function de(n,t){if(typeof cv>"u")return console.error("OpenCV not loaded"),[];const i=n.width,c=n.height,e=cv.matFromImageData(n);cv.cvtColor(e,e,cv.COLOR_RGBA2GRAY,0);const o=new cv.MatVector,s=new cv.Mat;cv.findContours(e,o,s,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE);const r=[],l=3,u=document.createElement("canvas");u.width=t.width,u.height=t.height;const p=u.getContext("2d");p.drawImage(t,0,0);const v=p.getImageData(0,0,t.width,t.height),R=cv.matFromImageData(v),d=t.width/i,f=t.height/c;for(let x=0;x<o.size();x++){const a=o.get(x),h=cv.minAreaRect(a);if(cv.RotatedRect.points(h),Math.min(h.size.width,h.size.height)<l)continue;const P=1.5,g=h.size.width,L=h.size.height,_=g*L,N=2*(g+L),F=_*P/N,X=new cv.Size(h.size.width+2*F,h.size.height+2*F),z=new cv.RotatedRect(h.center,X,h.angle),m=cv.RotatedRect.points(z).map($=>({x:$.x*d,y:$.y*f})),T=Math.max(Math.hypot(m[0].x-m[1].x,m[0].y-m[1].y),Math.hypot(m[2].x-m[3].x,m[2].y-m[3].y)),W=Math.max(Math.hypot(m[1].x-m[2].x,m[1].y-m[2].y),Math.hypot(m[3].x-m[0].x,m[3].y-m[0].y)),y=me(m),q=cv.matFromArray(4,1,cv.CV_32FC2,[y[0].x,y[0].y,y[1].x,y[1].y,y[2].x,y[2].y,y[3].x,y[3].y]),K=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,T,0,T,W,0,W]),Y=cv.getPerspectiveTransform(q,K),O=new cv.Mat;if(cv.warpPerspective(R,O,Y,new cv.Size(T,W),cv.INTER_CUBIC,cv.BORDER_REPLICATE,new cv.Scalar),O.rows/O.cols>=1.5){const $=new cv.Mat;cv.rotate(O,$,cv.ROTATE_90_CLOCKWISE),O.delete(),r.push({mat:$,box:y})}else r.push({mat:O,box:y});q.delete(),K.delete(),Y.delete()}return e.delete(),o.delete(),s.delete(),R.delete(),r.sort((x,a)=>x.box[0].y-a.box[0].y),r}function me(n){n.sort((r,l)=>r.x-l.x);const t=n.slice(0,2),i=n.slice(2,4);t.sort((r,l)=>r.y-l.y);const c=t[0],e=t[1];i.sort((r,l)=>r.y-l.y);const o=i[0],s=i[1];return[c,o,s,e]}function ue(n){const i=Math.ceil(n.cols*(48/n.rows)),c=new cv.Size(i,48),e=new cv.Mat;cv.resize(n,e,c,0,0,cv.INTER_LINEAR);const o=e.data,s=[],r=[],l=[];for(let p=0;p<o.length;p+=4)s.push((o[p]/255-.5)/.5),r.push((o[p+1]/255-.5)/.5),l.push((o[p+2]/255-.5)/.5);e.delete();const u=Float32Array.from([...l,...r,...s]);return new G.Tensor("float32",u,[1,3,48,i])}function he(n,t){const i=n.dims;i[2],i[0];const c=i[1],e=i[2],o=n.data;let s="",r=0;const l=[],u=[];for(let d=0;d<c;d++){let f=-1/0,x=-1;const a=d*e;for(let h=0;h<e;h++){const E=o[a+h];E>f&&(f=E,x=h)}l.push(x),u.push(f)}const p=[],v=[];for(let d=0;d<l.length;d++){const f=l[d];f!==0&&(d>0&&f===l[d-1]||(p.push(f),v.push(u[d])))}return s=p.map(d=>t[d-1]||"").join(""),v.length>0&&(r=v.reduce((d,f)=>d+f,0)/v.length),{text:s,meanProb:r}}ce.env.wasm.wasmPaths="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.23.2/dist/";const J=await ie(),se=new URLSearchParams(window.location.search),pe=se.get("model")||"0";let b,D;pe==="1"?(b=`https://${J}/webnn/PP-OCRv5-ONNX/resolve/main`,D={det:`${b}/ch_PP-OCRv5_det.onnx`,rec:`${b}/ch_PP-OCRv5_rec.onnx`,dic:`${b}/ch_PP-OCRv5_dict.txt`}):(b=`https://${J}/webnn/PP-OCRv4-ONNX/resolve/main`,D={det:`${b}/ch_PP-OCRv4_det.onnx`,rec:`${b}/ch_PP-OCRv4_rec.onnx`,dic:`${b}/ch_PP-OCR_keys_v1.txt`});let S=null,A=null,j=[],Q=null,k=null,Z=null,H=null,U=null,w=se.get("device")||"wasm",I="";w==="wasm"?I="Wasm":w==="webgpu"?I="WebGPU":w.startsWith("webnn")?I=`WebNN (${(w.includes("-")?w.split("-")[1]:"GPU").toUpperCase()})`:I=w;const C=document.getElementById("status"),fe=document.getElementById("backend-display"),ge=document.getElementById("upload"),ee=document.getElementById("result-container"),V=document.getElementById("canvas-overlay"),te=document.getElementById("image-preview"),we=document.getElementById("detCom"),xe=document.getElementById("detInf"),ve=document.getElementById("recCom"),ye=document.getElementById("recInf"),Ce=document.getElementById("backend");async function Re(){for(C.textContent="Loading OpenCV...";typeof cv>"u";)await new Promise(c=>setTimeout(c,100));C.textContent="OpenCV Loaded. Loading Dictionary...",j=(await(await fetch(D.dic)).text()).split(`
`),j.push(" "),fe.textContent=I,Ce.textContent=` Â· ${I}`,C.textContent="Ready. Upload image.",ge.addEventListener("change",async c=>{if(c.target.files.length>0){const e=c.target.files[0];await oe(e)}});const i=document.getElementById("example-link");i&&i.addEventListener("click",async c=>{c.preventDefault(),await oe("https://ibelem.github.io/webnn-hf-spaces/on-device-ocr/assets/invoice.jpg")})}async function ne(n){if(n==="det"&&S)return S;if(n==="rec"&&A)return A;C.textContent=`Loading ${n} model (${w})...`;const t={executionProviders:[w]};if(w.startsWith("webnn")){const r=w.includes("-")?w.split("-")[1]:"gpu";t.executionProviders=[{name:"webnn",deviceType:r,powerPreference:"default"}]}else w==="webgpu"?t.executionProviders=[{name:w,deviceType:"gpu",powerPreference:"default"}]:t.executionProviders=[{name:w,deviceType:"cpu",powerPreference:"default"}];const i=n==="det"?D.det:D.rec;let c=performance.now();const e=await ce.InferenceSession.create(i,t),s=performance.now()-c;return n==="det"?(Q=s,we.textContent=`${Q.toFixed(2)}`,console.log(`Detection model compilation time: ${s.toFixed(2)}ms`)):(Z=s,ve.textContent=`${Z.toFixed(2)}`,console.log(`Recognition model compilation time: ${s.toFixed(2)}ms`)),n==="det"&&S===null?S=e:n==="rec"&&A===null&&(A=e),e}async function oe(n){try{C.textContent="Processing image...",ee.innerHTML="";const t=await re(n);te.src=t.src,te.style.display="block";const i=await ne("det");C.textContent="Running Detection...";const{tensor:c,width:e,height:o,originalWidth:s,originalHeight:r,imageData:l}=ae(t),u={};u[i.inputNames[0]]=c;const p=performance.now(),v=await i.run(u);k=performance.now()-p,xe.textContent=`${k.toFixed(2)}`,console.log(`Detection inference time: ${k.toFixed(2)}ms`);const d=v[i.outputNames[0]],f=le(d,e,o);C.textContent="Splitting lines...";const x=de(f,t);V.width=s,V.height=r;const a=V.getContext("2d");a.clearRect(0,0,s,r),a.strokeStyle="red",a.lineWidth=2,x.forEach(P=>{const g=P.box;a.beginPath(),a.moveTo(g[0].x,g[0].y),a.lineTo(g[1].x,g[1].y),a.lineTo(g[2].x,g[2].y),a.lineTo(g[3].x,g[3].y),a.closePath(),a.stroke()}),C.textContent="Running Recognition...";const h=await ne("rec");let E="";for(let P=0;P<x.length;P++){const g=x[P],L=ue(g.mat),_={};_[h.inputNames[0]]=L;const N=performance.now(),F=await h.run(_);H=performance.now()-N,console.log(`Recognition inference time (line ${P+1}): ${H.toFixed(2)}ms`),U=(U||0)+H;const z=F[h.outputNames[0]],{text:B,meanProb:m}=he(z,j);if(m>.3){E+=B+`
`;const T=document.createElement("p");T.textContent=`[${m.toFixed(2)}] ${B}`,ee.appendChild(T)}else console.log(`Low confidence line skipped: "${B}" (${m.toFixed(2)})`);g.mat.delete()}ye.textContent=`${U.toFixed(2)}`,C.textContent=`${I} OCR complete.`,console.log(`OCR Result:
`,E)}catch(t){console.error(t),C.textContent=`Error: ${t.message}`}}Re();
